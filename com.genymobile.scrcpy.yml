id: com.genymobile.scrcpy

runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk

command: scrcpy.sh

add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    add-ld-path: .

cleanup:
  - /share/bash-completion
  - /share/zsh-completion
cleanup-commands:
  - mv -f /app/share/icons/hicolor/256x256/apps/scrcpy.png /app/share/icons/hicolor/256x256/apps/com.genymobile.scrcpy.png
  - mv -f /app/share/applications/scrcpy.desktop /app/share/applications/com.genymobile.scrcpy.desktop
  - rm -f /app/share/applications/scrcpy-console.desktop
  - sed -Ei 's#(Exec=).+#\1/app/bin/scrcpy.sh#' /app/share/applications/com.genymobile.scrcpy.desktop
  - sed -Ei 's#(Icon=).+#\1com.genymobile.scrcpy#' /app/share/applications/com.genymobile.scrcpy.desktop

finish-args:
  - --device=all
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=x11
  - --persist=.android

modules:
  - shared-modules/libusb/libusb.json
  - name: adb
    buildsystem: simple
    build-commands:
      - install -D adb /app/bin/adb
    sources:
      - type: archive
        url: https://dl.google.com/android/repository/platform-tools_r35.0.1-linux.zip
        sha256: 823d270be01444828ccd09e94209ff394fb8a8457243e1c15689fe0544acbc72
        x-checker-data:
          type: anitya
          project-id: 226905
          url-template: https://dl.google.com/android/repository/platform-tools_r$version-linux.zip
  - name: scrcpy
    buildsystem: meson
    config-opts:
      - --buildtype=release
      - -Db_lto=true
      - -Dprebuilt_server=scrcpy-server
      - --strip
    sources:
      - type: archive
        url: https://github.com/Genymobile/scrcpy/archive/refs/tags/v2.6.1.tar.gz
        sha256: 4948474f1494fdff852a0a7fa823a0b3c25d3ea0384acdaf46c322e34b13e449
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Genymobile/scrcpy/releases/latest
          version-query: .tag_name | sub("v"; "")
          url-query: '"https://github.com/Genymobile/scrcpy/archive/refs/tags/v" +
            $version + ".tar.gz"'
      - type: file
        url: https://github.com/Genymobile/scrcpy/releases/download/v2.6.1/scrcpy-server-v2.6.1
        sha256: ca7ab50b2e25a0e5af7599c30383e365983fa5b808e65ce2e1c1bba5bfe8dc3b
        dest-filename: scrcpy-server
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Genymobile/scrcpy/releases/latest
          version-query: .tag_name | sub("v"; "")
          url-query: '"https://github.com/Genymobile/scrcpy/releases/download/v" +
            $version + "/scrcpy-server-v" + $version'
  - name: scrcpy-wrapper
    buildsystem: simple
    build-commands:
      - install -D scrcpy.sh /app/bin/scrcpy.sh
    sources:
      - type: file
        path: scrcpy.sh
  - name: scrcpy-metadata
    buildsystem: simple
    build-commands:
      - install -D com.genymobile.scrcpy.metainfo.xml /app/share/metainfo/com.genymobile.scrcpy.metainfo.xml
    sources:
      - type: file
        path: com.genymobile.scrcpy.metainfo.xml
